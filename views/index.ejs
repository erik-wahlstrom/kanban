<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kanban!</title>
    <link rel="stylesheet" href="./public/stylesheets/dnd.css">
    <link rel="stylesheet" href="./public/stylesheets/sticky.css">
    <link rel="stylesheet" href="./public/stylesheets/Modal.css">
    <script src="./public/scripts/test.js"></script>
    <script src="./public/scripts/util.js"></script>
    <script src="./public/scripts/WorkItemProxy.js"></script>

</head>
<body >
    <div id="modal-add-task" class="modal" >
        <div class="modal-content"  >
            <div  style="float:left;">
                <table>
                    <tr><td><label class="input-label">Owner:</label></td>
                        <td>
                            <select id="sel-owner_id">
                                <option value="1">Erik</option>
                            </select>
                        </td>
                    </tr>
                    <tr><td><label class="input-label">Group:</label></td>
                        <td>
                            <section id="sel-work_item_group_id">
                                <option value="1">Default</option>
                            </section>
                        </td>
                    </tr>
                    <tr><td><label class="input-label">Description:</label></td>
                        <td><input  id="txt-description" type="text" class="input-field" style="width: 500px; height:150px;"/></td></tr>
                    <tr><td></td>
                        <td><input  id="btn-create" type="button" value="Submit" style="float:right" onclick="CreateTask();"/></td></tr>
                </table>
            </div>
            <div  style="float:right;">
                <span class="close" style="position:relative; top:-20px; right:-10px;font:arial;">x</span>
            </div>  
        </div>
    </div>

    <div class="main_header">
        <header><h2>The Kanban Board!<h2></header>
        <table style="color:#000;">
            <tr><td><strong>User:</strong>&nbsp;</td><td>All</td></tr>
            <tr><td><strong>Group:</strong>&nbsp;</td><td>Default</td></tr>
            <tr><td><strong>Add a task:</strong>&nbsp;</td><td>
                <input id="btn-add-task" type="button" value="Click me" onclick="javascript:ShowModal();"></input></td></tr>
        </table>
    </div>
    <div id="columns">
    </div>
    <script type="text/javascript">
    //<![CDATA[

        var stateMapping = [];
        <%         
        var states = [  [0, "error", "Error", false], 
                        [1, "not-started", "Not started", true],
                        [2, "active", "Active", true],
                        [3, "complete", "Complete", true],
                        [4, "deleted", "Deleted", false],
                     ];
        for(var i=0; i<states.length; i++) {
            %>stateMapping.push('<%= states[i][1]%>');
        CreateColumn('columns', <%= states[i][0] %>, '<%= states[i][1] %>', '<%= states[i][2] %>', <%= states[i][3]%>);
        <%  } %>

    function CreateTask() {
        var wi = new WorkItem();
        wi.error = function(response) {
            HandleError("Could not create record(s)", response);
        }
        wi.success = function(response) {
            //Add sticky
            var wi2 = new WorkItem();
            wi2.id = response.data.id;
            wi2.error = function(response) {
                HandleError("Could not retreive record(s)", response);
            }
                wi2.success = function(response) {
                AppendTask( "column-" + stateMapping[response.data.state_id], response.data);
                closeModal();
            }
            wi2.FindWorkItem();
        }
        wi.description = GetValueById('txt-description');
        wi.person_id = parseInt(GetValueById('sel-owner_id'));
        wi.work_item_group_id = parseInt(GetValueById('sel-owner_id'));
        wi.CreateWorkItem();
    }

    function closeModal() {
        var modal = document.getElementById('modal-add-task');
        modal.style.display = "none";
    }

        //<div id="column-not-started" class="column" ><header>Not Started</header></div>
        function CreateColumn(parentId, state_id, state_name, description, include) {
            if (include) {
                var parent = document.getElementById(parentId);
                var div = parent.appendChild(document.createElement("div"));
                div.setAttribute("id", "column-" + state_name);
                div.setAttribute("class", "column");
                div.setAttribute("draggable", "true");
                div.state_id = state_id;
                div.state_name = state_name;
                var header = div.appendChild(document.createElement("header"));
                var p = header.appendChild(document.createElement("p"));
                p.appendChild(document.createTextNode(description));
                var ul = div.appendChild(document.createElement("ul"));

            }
        }
        
        FindWorkItemsByGroup(1);

        function columnDragOver(e) { 
            if (e.preventDefault) {
                e.preventDefault(); // Necessary. Allows us to drop.
            }
        }
        function columnDrop(e) { 
            var task = JSON.parse(e.dataTransfer.getData("json"));
            var columnId = e.id;
            console.log("Dropping: " + task.description);
            UpdateState(task, e.target.state_id, e.target.state_name);
        }


        var columns = document.querySelectorAll(".column");
        [].forEach.call(columns, function(column) {
            column.addEventListener('dragover', columnDragOver, false);
            column.addEventListener('drop', columnDrop, false);
        });

        function taskDragStart(e) { 
            // Target (this) element is the source node.
            this.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('json', JSON.stringify(e.srcElement.task));
        }
        function taskDrag(e) { 
            // Target (this) element is the source node.
            this.style.opacity = '1.0';
        }

/***************************************************************/
/***************************************************************/
/** General UI **/
/***************************************************************/
/***************************************************************/
//    <li>
//      <a href="#">
//        <h2>Title #1</h2>
//        <p>Text Content #1</p>
//      </a>
//    </li>
function AppendTask(columnId, task) {
    var div = document.getElementById(columnId);
    div.task_id = task.id;
    div.ondblclick= taskDoubleClick;
    var ul = div.childNodes[1];

    var li = ul.appendChild(document.createElement("li"));
    li.setAttribute("id","task-" + task.id);
    li.setAttribute("draggable", "true");

    var a = li.appendChild(document.createElement("a"));
    a.setAttribute("href", "#");
    a.task = task;
    var h2 = a.appendChild(document.createElement("h2"));
    h2.appendChild(document.createTextNode("Id: " + task.id));
    var p = a.appendChild(document.createElement("p"));

    var person_name = task.person_name ? task.person_name : "(empty)";
    var description = task.description ? task.description : "(empty)";
    var created_date = task.created_date ? task.created_date : "(empty)";

    var fields = [ ['Owner', person_name, 50]
        , ['Description', description, 140]
        , ['Created', FormatDate(created_date), 50] ];

    fields.forEach( function(field) {
        var name = p.appendChild(document.createElement("h3"));
        var value = field[0] + ": " + field[1].substring(0,field[2]);
        name.appendChild(document.createTextNode(value));
    });

    li.addEventListener('dragstart', taskDragStart, false);
    li.addEventListener('drag', taskDrag, false);

    return div;
}

function taskDoubleClick(e) {
    var parent = FindParent(e.srcElement, "a");
    if (parent) {
        var task_id = parent.task.id;
        if((confirm("Delete task '" + task_id + "'?"))) {
            var task = {id: task_id, state_id: 4, description: 'Deleted'};
            DeleteTask(task);
        }
    }
}

/***************************************************************/
/***************************************************************/
/** Tasks **/
/***************************************************************/
/***************************************************************/
    function ClearTasks()
    {
        var tasks = document.querySelectorAll(".task");
        [].forEach.call(tasks, function(task) {ClearTask(task)});
    }

    function ClearTask(task) {
        var parent = task.parentNode;
        parent.removeChild(task);
    }

    function FindWorkItemsByGroup(work_item_group_id)
    {
        var wi = new WorkItem();

        wi.error = function(response) {
            HandleError("Could not retreive record(s)", response);
        }
        wi.success = function(response) {
            ClearTasks();
            InitTasks(response.data);
        }
        wi.work_item_group_id = work_item_group_id;
        wi.FindWorkItemsByGroup();
    }

    function InitTasks(arrTasks) {
        arrTasks.forEach( function(task){ 
            var column = stateMapping[task.state_id];
            var div = document.getElementById("column-" + column);
            if (div) {
                AppendTask("column-" + column, task);
            }
        });
    }


    function UpdateState(task, newState, stateName) {
        //Start doing the DB Update to the new state
        var wi = new WorkItem();
        wi.id = task.id;
        wi.state_id = newState;
        wi.description = task.description;        
        task.state_id = newState;


        wi.error = function(response) {
            HandleError("Could not update record: " + wi.id, response);
        }
        wi.success = function(response) {
            //If this was sucessful then 
            //Delete the old one.
            var div = document.getElementById("task-" + task.id);
            ClearTask(div);
            //Create the new Item
            AppendTask("column-" + stateName, task );
        }
        wi.UpdateWorkItem();
    }
    function DeleteTask(task) {
        //Start doing the DB Update to the new state
        var wi = new WorkItem();
        wi.id = task.id;
        wi.state_id = 4;
        task.state_id = 4;


        wi.error = function(response) {
            HandleError("Could not delete record: " + wi.id, response);
        }
        wi.success = function(response) {
            //If this was sucessful then 
            //Delete the old one.
            var task_div = "task-" + task.id;
            var div = document.getElementById(task_div);
            ClearTask(div);
        }

        wi.UpdateWorkItem();
    }

    window.onload = function() {
        var modal = document.getElementById('modal-add-task');
        var span = document.getElementsByClassName('close')[0];

        // Get the button that opens the modal
        var btn = document.getElementById('btn-add-task');
        // When the user clicks on the button, open the modal 
        btn.onclick = function() {
            modal.style.display = "block";
        }
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            closeModal();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        var closeModal = function() {
            modal.style.display = "none";
        }
    }

    //]]>
  </script>
</body>
 